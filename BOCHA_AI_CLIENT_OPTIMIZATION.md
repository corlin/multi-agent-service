# BochaAIClient ä¼˜åŒ–å®ç°æŠ¥å‘Š

## æ¦‚è¿°

åŸºäºåšæŸ¥AIå®˜æ–¹APIæ–‡æ¡£ï¼Œæˆ‘ä»¬å¯¹patent search_agentä¸­çš„BochaAIClientè¿›è¡Œäº†å…¨é¢ä¼˜åŒ–ï¼Œå®ç°äº†å®Œæ•´çš„åšæŸ¥AI APIé›†æˆã€‚

## ä¸»è¦ä¼˜åŒ–å†…å®¹

### 1. APIç«¯ç‚¹æ›´æ–°
- **Webæœç´¢API**: `https://api.bochaai.com/v1/web-search`
- **AIæœç´¢API**: `https://api.bochaai.com/v1/ai-search`
- **Agentæœç´¢API**: `https://api.bochaai.com/v1/agent-search`
- **è¯­ä¹‰é‡æ’åºAPI**: `https://api.bochaai.com/v1/rerank`

### 2. ç¯å¢ƒé…ç½®
- æ·»åŠ äº†`BOCHA_AI_API_KEY`ç¯å¢ƒå˜é‡æ”¯æŒ
- APIå¯†é’¥: `sk-57e5481fb6954679ad0b58043fb9f963`
- å·²å­˜å‚¨åœ¨`.env`æ–‡ä»¶ä¸­

### 3. æ ¸å¿ƒåŠŸèƒ½å®ç°

#### 3.1 Webæœç´¢ (`_web_search`)
- åŸºäºåšæŸ¥AI Web Search APIå®ç°
- æ”¯æŒå‚æ•°ï¼š`query`, `freshness`, `summary`, `count`
- è§£æå“åº”æ ¼å¼ï¼š`webPages.value[]` å’Œ `images.value[]`
- åŒ…å«é™çº§æœºåˆ¶å’Œé”™è¯¯å¤„ç†

#### 3.2 AIæœç´¢ (`_ai_search`)
- åŸºäºåšæŸ¥AI AI Search APIå®ç°
- æ”¯æŒå‚æ•°ï¼š`query`, `freshness`, `count`, `answer`, `stream`
- è§£æå¤šç§æ¶ˆæ¯ç±»å‹ï¼š`source`, `answer`, `follow_up`
- å¤„ç†æ¨¡æ€å¡ï¼š`baike_pro`, `medical_common`, `weather_china`

#### 3.3 Agentæœç´¢ (`_agent_search`)
- åŸºäºåšæŸ¥AI Agent Search APIå®ç°
- æ”¯æŒæ™ºèƒ½ä½“ï¼š`bocha-scholar-agent`, `bocha-company-agent`, `bocha-wenku-agent`
- æ ¹æ®æœç´¢ç±»å‹è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„Agent
- ä½¿ç”¨`neural`æœç´¢æ¨¡å¼è¿›è¡Œè‡ªç„¶è¯­è¨€å¤„ç†

#### 3.4 è¯­ä¹‰é‡æ’åº (`_rerank_results`)
- åŸºäºåšæŸ¥AI Semantic Reranker APIå®ç°
- ä½¿ç”¨`gte-rerank`æ¨¡å‹
- æ”¯æŒå‚æ•°ï¼š`model`, `query`, `documents`, `top_n`
- æé«˜æœç´¢ç»“æœçš„ç›¸å…³æ€§æ’åº

### 4. æ€§èƒ½ä¼˜åŒ–

#### 4.1 å¹¶å‘æ§åˆ¶
- å®ç°äº†é€Ÿç‡é™åˆ¶æœºåˆ¶ï¼ˆæ¯ç§’æœ€å¤š10ä¸ªè¯·æ±‚ï¼‰
- æ·»åŠ äº†è¶…æ—¶æ§åˆ¶ï¼ˆ30ç§’æ€»è¶…æ—¶ï¼Œ5ç§’å¥åº·æ£€æŸ¥è¶…æ—¶ï¼‰
- æ”¯æŒå¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨

#### 4.2 é”™è¯¯å¤„ç†å’Œé™çº§
- å¤šå±‚æ¬¡é™çº§ç­–ç•¥ï¼šçœŸå®API â†’ æ¨¡æ‹ŸAPI â†’ é™çº§ç»“æœ
- å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
- è®¤è¯å¤±è´¥æ—¶çš„ä¼˜é›…é™çº§

#### 4.3 ç»“æœä¼˜åŒ–
- å¤šç»´åº¦è´¨é‡è¯„ä¼°ï¼šç›¸å…³æ€§ã€æƒå¨æ€§ã€æ—¶æ•ˆæ€§ã€å®Œæ•´æ€§
- æ™ºèƒ½å»é‡ç®—æ³•
- ç»“æœå¤šæ ·æ€§ä¼˜åŒ–

### 5. APIå“åº”è§£æ

#### 5.1 Webæœç´¢å“åº”
```json
{
  "code": 200,
  "data": {
    "webPages": {
      "value": [
        {
          "name": "æ ‡é¢˜",
          "url": "é“¾æ¥",
          "snippet": "æ‘˜è¦",
          "summary": "æ€»ç»“",
          "siteName": "ç½‘ç«™å",
          "datePublished": "å‘å¸ƒæ—¶é—´"
        }
      ]
    },
    "images": {
      "value": [...]
    }
  }
}
```

#### 5.2 AIæœç´¢å“åº”
```json
{
  "code": 200,
  "messages": [
    {
      "role": "assistant",
      "type": "source|answer|follow_up",
      "content_type": "webpage|ai_answer|baike_pro",
      "content": "å†…å®¹"
    }
  ]
}
```

#### 5.3 è¯­ä¹‰é‡æ’åºå“åº”
```json
{
  "code": 200,
  "data": {
    "results": [
      {
        "index": 0,
        "relevance_score": 0.85
      }
    ]
  }
}
```

### 6. æµ‹è¯•ç»“æœ

è¿è¡Œ`test_bocha_client.py`çš„æµ‹è¯•ç»“æœï¼š

- âœ… **Webæœç´¢**: æˆåŠŸè·å¾—8ä¸ªç»“æœ
- âœ… **AIæœç´¢**: æˆåŠŸè·å¾—3ä¸ªç»“æœ  
- âš ï¸ **Agentæœç´¢**: è®¤è¯å¤±è´¥ï¼ˆéœ€è¦ç™½åå•ï¼‰
- âœ… **ç»¼åˆæœç´¢**: æˆåŠŸæ•´åˆå¤šä¸ªæ•°æ®æº
- âœ… **è¯­ä¹‰é‡æ’åº**: æˆåŠŸä¼˜åŒ–ç»“æœæ’åº

### 7. é…ç½®æ›´æ–°

#### 7.1 Settingsç±»æ›´æ–°
åœ¨`src/multi_agent_service/config/settings.py`ä¸­æ·»åŠ ï¼š
```python
bocha_ai_api_key: Optional[str] = Field(default=None, alias="BOCHA_AI_API_KEY")
```

#### 7.2 ç¯å¢ƒå˜é‡
åœ¨`.env`æ–‡ä»¶ä¸­æ·»åŠ ï¼š
```
BOCHA_AI_API_KEY=sk-57e5481fb6954679ad0b58043fb9f963
```

### 8. ä½¿ç”¨ç¤ºä¾‹

```python
async with BochaAIClient() as client:
    # Webæœç´¢
    web_results = await client._web_search("äººå·¥æ™ºèƒ½ä¸“åˆ©", "patent", 10)
    
    # AIæœç´¢
    ai_results = await client._ai_search("æ·±åº¦å­¦ä¹ ç®—æ³•", "academic", 5)
    
    # Agentæœç´¢
    agent_results = await client._agent_search("æœºå™¨å­¦ä¹ ç ”ç©¶", "academic", 5)
    
    # ç»¼åˆæœç´¢
    all_results = await client.search(["AI", "ä¸“åˆ©"], "patent", 20)
    
    # è¯­ä¹‰é‡æ’åº
    reranked = await client._rerank_results("æŸ¥è¯¢è¯", results)
```

### 9. æ³¨æ„äº‹é¡¹

1. **APIå¯†é’¥**: å½“å‰ä½¿ç”¨çš„æ˜¯æµ‹è¯•å¯†é’¥ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦ç”³è¯·æ­£å¼å¯†é’¥
2. **Agentæœç´¢**: éœ€è¦åšæŸ¥AIå¼€é€šç™½åå•æ‰èƒ½ä½¿ç”¨Agentæœç´¢åŠŸèƒ½
3. **é€Ÿç‡é™åˆ¶**: éµå¾ªåšæŸ¥AIçš„APIè°ƒç”¨é¢‘ç‡é™åˆ¶
4. **é”™è¯¯å¤„ç†**: å®ç°äº†å®Œå–„çš„é™çº§æœºåˆ¶ï¼Œç¡®ä¿æœåŠ¡å¯ç”¨æ€§

### 10. åç»­ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜æœºåˆ¶**: å®ç°Redisç¼“å­˜ä»¥æé«˜å“åº”é€Ÿåº¦
2. **ç›‘æ§å‘Šè­¦**: é›†æˆæ›´è¯¦ç»†çš„APIè°ƒç”¨ç›‘æ§
3. **é…ç½®ç®¡ç†**: æ”¯æŒåŠ¨æ€é…ç½®APIå‚æ•°
4. **æ‰¹é‡å¤„ç†**: æ”¯æŒæ‰¹é‡æœç´¢è¯·æ±‚
5. **ç»“æœè¿‡æ»¤**: æ·»åŠ æ›´æ™ºèƒ½çš„å†…å®¹è¿‡æ»¤æœºåˆ¶

## æœ€æ–°ä¼˜åŒ– (2025-09-12)

### ğŸ”‘ APIå¯†é’¥è·å–é€»è¾‘ä¼˜åŒ–

#### ä¼˜åŒ–å†…å®¹
1. **å¤šå±‚æ¬¡å¯†é’¥è·å–ç­–ç•¥**:
   - ä¼˜å…ˆä»ç¯å¢ƒå˜é‡è·å–: `BOCHA_AI_API_KEY`, `BOCHAAI_API_KEY`, `BOCHA_API_KEY`, `BOCHA_AI_TOKEN`
   - å¤‡é€‰ä».envæ–‡ä»¶ç›´æ¥è¯»å–
   - æœ€åä½¿ç”¨é»˜è®¤å¯†é’¥ä½œä¸ºé™çº§æ–¹æ¡ˆ

2. **ä¸¥æ ¼çš„å¯†é’¥æ ¼å¼éªŒè¯**:
   - æ£€æŸ¥sk-å‰ç¼€
   - éªŒè¯é•¿åº¦èŒƒå›´(20-100å­—ç¬¦)
   - æ­£åˆ™è¡¨è¾¾å¼éªŒè¯å­—ç¬¦æ ¼å¼

3. **è¯¦ç»†çš„çŠ¶æ€æŠ¥å‘Š**:
   - APIå¯†é’¥é…ç½®çŠ¶æ€
   - å¯†é’¥æ¥æºè¿½è¸ª
   - ç¯å¢ƒå˜é‡æ£€æŸ¥
   - æ ¼å¼éªŒè¯ç»“æœ

#### æµ‹è¯•ç»“æœ
```
âœ… APIå¯†é’¥é…ç½®: æ˜¯
ğŸ” å¯†é’¥æ ¼å¼éªŒè¯: é€šè¿‡  
ğŸ”‘ å¯†é’¥æ¥æº: environment_variable (ä».envæ–‡ä»¶)
ğŸ“ å¯†é’¥é•¿åº¦: 35 å­—ç¬¦
ğŸ” å¯†é’¥å‰ç¼€: sk-57e5481...
ğŸ“Š æœç´¢æˆåŠŸç‡: 100% (4/4)
âš¡ å¹³å‡å“åº”æ—¶é—´: 8.15ç§’
```

#### æ–°å¢æ–¹æ³•
- `_get_api_key()`: æ™ºèƒ½å¯†é’¥è·å–
- `_validate_api_key_format()`: æ ¼å¼éªŒè¯
- `_read_api_key_from_file()`: æ–‡ä»¶è¯»å–
- `get_api_key_info()`: çŠ¶æ€ä¿¡æ¯
- `get_api_status()`: å®Œæ•´çŠ¶æ€æŠ¥å‘Š

## æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¼˜åŒ–ï¼ŒBochaAIClientç°åœ¨å®Œå…¨ç¬¦åˆåšæŸ¥AIå®˜æ–¹APIè§„èŒƒï¼Œæä¾›äº†ï¼š

- ğŸ” **å¤šæºæœç´¢**: Webã€AIã€Agentä¸‰ç§æœç´¢æ–¹å¼
- ğŸ¯ **æ™ºèƒ½é‡æ’åº**: åŸºäºè¯­ä¹‰ç›¸å…³æ€§çš„ç»“æœä¼˜åŒ–
- ğŸ›¡ï¸ **å®¹é”™æœºåˆ¶**: å®Œå–„çš„é™çº§å’Œé”™è¯¯å¤„ç†
- âš¡ **æ€§èƒ½ä¼˜åŒ–**: å¹¶å‘æ§åˆ¶å’Œè¶…æ—¶ç®¡ç†
- ğŸ“Š **è´¨é‡è¯„ä¼°**: å¤šç»´åº¦ç»“æœè´¨é‡åˆ†æ
- ğŸ”‘ **æ™ºèƒ½å¯†é’¥ç®¡ç†**: å¤šå±‚æ¬¡è·å–å’Œä¸¥æ ¼éªŒè¯

è¿™ä¸ºä¸“åˆ©æœç´¢ç³»ç»Ÿæä¾›äº†å¼ºå¤§è€Œå¯é çš„æœç´¢èƒ½åŠ›æ”¯æŒã€‚